name: Test CURRENT Unreachable List (no 48h)

on:
  workflow_dispatch: {}
  push:
    branches: [ main ]  # optional

permissions:
  contents: write

jobs:
  current-unreachable:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas requests

      - name: Run your existing script
        env:
          CP_USERNAME: ${{ secrets.CP_USERNAME }}
          CP_PASSWORD: ${{ secrets.CP_PASSWORD }}
          THRESHOLD_HOURS: '48'
        run: |
          python "mail out.py"

      - name: Build CURRENT unreachable CSV (no 48h threshold)
        run: |
          python - << 'PY'
          import pandas as pd
          from pathlib import Path

          src = Path('status_latest_slim.csv')
          if not src.exists():
            raise SystemExit("status_latest_slim.csv not found; did the script run?")

          df = pd.read_csv(src)

          # Normalize fields
          lps = df.get("LastPortStatus", pd.Series([""]*len(df))).fillna("").astype(str).str.upper().str.strip()
          net = df.get("StationNetworkStatus", pd.Series([""]*len(df))).fillna("").astype(str).str.upper().str.strip()

          unreachable_mask = lps.isin({"UNAVAILABLE","OUTOFORDER","FAULTED","MAINTENANCE"}) | net.isin({"UNAVAILABLE","OFFLINE"})

          cols = ["stationID","stationName","Address","City","State","Charger type","stationModel",
                  "StationNetworkStatus","LastPortStatus","faultReason","StatusTimestamp","hours_unreachable"]
          cols = [c for c in cols if c in df.columns]
          out = df.loc[unreachable_mask, cols].copy()
          if "Charger type" in out.columns:
            out.rename(columns={"Charger type":"charger_type"}, inplace=True)
          out.to_csv("alerts_unreachable_current.csv", index=False, encoding="utf-8")
          print(f"Wrote alerts_unreachable_current.csv with {len(out)} rows.")
          PY

      - name: Commit CURRENT list (and usual outputs) if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add alerts_unreachable_current.csv alerts_unreachable_gt48.csv alerts_unreachable_gt48.json \
                  .cp_unreach_state.json status_latest_slim.csv stations_per_station_slim.csv chargepoint_refresh.log 2>/dev/null || true
          git diff --staged --quiet || git commit -m "Add current unreachable list ($(date -u +%Y-%m-%dT%H:%M:%SZ))"
          git push || true

      - name: Upload CSV as artifact (for easy download)
        uses: actions/upload-artifact@v4
        with:
          name: alerts_unreachable_current
          path: alerts_unreachable_current.csv
