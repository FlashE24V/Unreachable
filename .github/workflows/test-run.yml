name: ChargePoint Fetch + Outputs (auto)

on:
  # Runs every 2 days at ~5:00 AM New York time (10:00 UTC)
  schedule:
    - cron: "0 10 */2 * *"
  workflow_dispatch: {}      # allow manual runs from the Actions tab
  push:
    branches: [ main ]       # optional: also run when you push to main

permissions:
  contents: write

jobs:
  fetch-and-commit:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas requests

      # Run YOUR script â€” adjust the file name below if needed.
      # Quotes are important because your file name has a space.
      - name: Run ChargePoint fetch/analyzer
        env:
          CP_USERNAME: ${{ secrets.CP_USERNAME }}
          CP_PASSWORD: ${{ secrets.CP_PASSWORD }}
          THRESHOLD_HOURS: '48'   # optional; your script defaults to 48 if not set
        run: |
          python "mail out.py"

      - name: Verify expected outputs
        run: |
          ls -la
          test -f status_latest_slim.csv || (echo "status_latest_slim.csv not found after script run" && exit 1)
          test -f stations_per_station_slim.csv || echo "stations_per_station_slim.csv missing (non-fatal)"
          test -f alerts_unreachable_gt48.json   || echo "alerts_unreachable_gt48.json missing (non-fatal)"
          test -f .cp_unreach_state.json         || echo ".cp_unreach_state.json missing (non-fatal)"
          test -f chargepoint_refresh.log        || echo "chargepoint_refresh.log missing (non-fatal)"

      - name: Commit updates if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add \
            status_latest_slim.csv \
            stations_per_station_slim.csv \
            alerts_unreachable_gt48.json \
            .cp_unreach_state.json \
            chargepoint_refresh.log 2>/dev/null || true
          git diff --staged --quiet || git commit -m "Auto: CP refresh ($(date -u +%Y-%m-%dT%H:%M:%SZ))"
          git push || true

      - name: Upload artifacts (download from run page)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cp-outputs
          path: |
            status_latest_slim.csv
            stations_per_station_slim.csv
            alerts_unreachable_gt48.json
            .cp_unreach_state.json
            chargepoint_refresh.log
